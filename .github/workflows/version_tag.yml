name: Version Tagging

on:
  push:
    branches:
      - master

jobs:
  version-tag:
    runs-on: ubuntu-latest

    steps:
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Check out the repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: npm install

    - name: Determine new version
      id: new_version
      run: |
        # Extract the latest tag
        latest_tag=$(git describe --tags `git rev-list --tags --max-count=1`)
        echo "Latest tag: $latest_tag"

        # Get the commit message of the latest commit
        commit_message=$(git log -1 --pretty=%B)
        echo "Commit message: $commit_message"

        # Determine the new version based on the commit message
        if [[ $commit_message == *"BREAKING CHANGE"* ]]; then
          new_version=$(echo $latest_tag | awk -F. -v OFS=. '{$1+=1; $2=0; $3=0; print}')
        elif [[ $commit_message == feat* ]]; then
          new_version=$(echo $latest_tag | awk -F. -v OFS=. '{$2+=1; $3=0; print}')
        elif [[ $commit_message == fix* ]]; then
          new_version=$(echo $latest_tag | awk -F. -v OFS=. '{$3+=1; print}')
        else
          new_version=$latest_tag
        fi

        echo "New version: $new_version"
        echo "::set-output name=version::$new_version"

    - name: Create new version tag
      if: steps.new_version.outputs.version != steps.new_version.outputs.latest_tag
      run: |
        new_version=${{ steps.new_version.outputs.version }}
        git tag $new_version
        git push origin $new_version

    - name: Delete old tags
      run: |
        tags=$(git tag -l | sort -V)
        tags_to_delete=$(echo "$tags" | head -n -3)
        for tag in $tags_to_delete; do
          git tag -d $tag
          git push origin :refs/tags/$tag
        done
